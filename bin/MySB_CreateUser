#!/bin/bash 
# ----------------------------------
source /etc/MySB/inc/includes_before
# ----------------------------------
#  __/\\\\____________/\\\\___________________/\\\\\\\\\\\____/\\\\\\\\\\\\\___
#   _\/\\\\\\________/\\\\\\_________________/\\\/////////\\\_\/\\\/////////\\\_
#    _\/\\\//\\\____/\\\//\\\____/\\\__/\\\__\//\\\______\///__\/\\\_______\/\\\_
#     _\/\\\\///\\\/\\\/_\/\\\___\//\\\/\\\____\////\\\_________\/\\\\\\\\\\\\\\__
#      _\/\\\__\///\\\/___\/\\\____\//\\\\\________\////\\\______\/\\\/////////\\\_
#       _\/\\\____\///_____\/\\\_____\//\\\____________\////\\\___\/\\\_______\/\\\_
#        _\/\\\_____________\/\\\__/\\_/\\\______/\\\______\//\\\__\/\\\_______\/\\\_
#         _\/\\\_____________\/\\\_\//\\\\/______\///\\\\\\\\\\\/___\/\\\\\\\\\\\\\/__
#          _\///______________\///___\////__________\///////////_____\/////////////_____
#			By toulousain79 ---> https://github.com/toulousain79/
#
######################################################################

if [ "$USAGE" == "ON" ]; then
	ListingUsers
	for seedUser in $UsersList; do
		LIST="$LIST|$seedUser"
	done
	LIST="`echo \($LIST\) | sed -e 's/(|/(/g;'`"

	if [ ! -z "$LIST" ]; then
		echo -e "${CBLUE}Available users: $CEND${CYELLOW}$LIST$CEND"
	fi
	
	QuestionGetString NO  "Username for your seedbox: " UserToCreate
	while [ ! "`echo \"$LIST\" | grep $UserToCreate`" = "" ]; do
		QuestionGetString NO  "Username for your seedbox: " UserToCreate
	done

	NewUserPassword="`GenPassword 8`"
	if [ -z "NewUserPassword" ]; then
		QuestionGetString YES "Password for user $UserToCreate: " NewUserPassword
	fi
	
	QuestionGetString NO  "User can login via SFTP? " UserSFTP YES
	
	#QuestionGetString NO  "Add user to sudoers? " UserSUDO NO
	UserSUDO="NO"
	
	while [ ! "`ValidateMail $UserEmail`" = "1" ]; do
		QuestionGetString NO  "Email for this user? " UserEmail
	done

	UserSFTP="$(echo $UserSFTP | sed 's/YES/1/g;' | sed 's/NO/0/g;')"
	UserSUDO="$(echo $UserSUDO | sed 's/YES/1/g;' | sed 's/NO/0/g;')"
else
	# It is the main user creation
	UserToCreate="$1"
	NewUserPassword="$2"
	UserSFTP=$3
	UserSUDO=$4
	if [ ! -z "$6" ]; then	# APPLYCONFIG
		UserEmail="$5"
		Type="$6"
	else					# INSTALL
		UserEmail="$MainUserEmail"
		Type="$5"
	fi
fi

#### Users vars
NewUserHomedir="/home/$UserToCreate"
HOMEDIR_ESCAPED=`echo $NewUserHomedir | sed s,/,\\\\\\\\\\/,g`
UPPERNEWUSER=`echo $UserToCreate | tr '[:lower:]' '[:upper:]'`
NEWRPC=$UPPERNEWUSER

#### Users infos
ListingUsers
CountingUsers

NETWORKPORT="`sqlite3 $MySB_DB \"SELECT value FROM ports ORDER BY rowid DESC LIMIT 1\"`"
sqlite3 $MySB_DB "DELETE FROM ports WHERE value = '$NETWORKPORT';"
SCGIPORT="`sqlite3 $MySB_DB \"SELECT value FROM ports ORDER BY rowid DESC LIMIT 1\"`"
sqlite3 $MySB_DB "DELETE FROM ports WHERE value = '$SCGIPORT';"

#### user infos
if [ "$MainUser" != "$UserToCreate" ]; then
	log_daemon_msg "Insert user informations in database"
	sqlite3 $MySB_DB "INSERT into users (users_ident,users_email,users_passwd,rpc,sftp,sudo,scgi_port,rtorrent_port,home_dir) VALUES (\"$UserToCreate\",\"$UserEmail\",\"$NewUserPassword\",\"$NEWRPC\",\"$UserSFTP\",\"$UserSUDO\",\"$SCGIPORT\",\"$NETWORKPORT\",\"$NewUserHomedir\");"
else
	log_daemon_msg "Update user informations in database"
	sqlite3 $MySB_DB "UPDATE users SET users_passwd = '', rpc = '$NEWRPC', scgi_port = '$SCGIPORT', rtorrent_port = '$NETWORKPORT', home_dir = '$NewUserHomedir' WHERE users_ident = '$UserToCreate';"
fi
StatusLSB

#### create system user
log_daemon_msg "Create the system account for $UserToCreate"
useradd -c "MySB user $UserToCreate" -d $NewUserHomedir -s /bin/bash $UserToCreate &> /dev/null
StatusLSB

#### create directories
log_daemon_msg "Manage files et directories for $UserToCreate"
# Home
ManageUserHomeDir "$FnUser"
# ruTorrent
ruTorrentUsersConfigs "$FnUser"
# Seedbox-Manager
ManagerUsersConfigs "$FnUser"
# Cakebox-Light
CakeboxUsersConfigs "$FnUser"
StatusLSB

#### FTP
log_daemon_msg "Allow use of FTP and share for $UserToCreate"
echo "$UserToCreate" >> /etc/vsftpd.chroot_list
mount --bind /home/MySB_share $NewUserHomedir/rtorrent/share
StatusLSB

#### add to groups
log_daemon_msg "Assign user groups to $UserToCreate"
addgroup $UserToCreate MySB_users &> /dev/null

if [ "$UserSUDO" == "YES" ]; then
	addgroup $UserToCreate sudo &> /dev/null
fi
if [ "$UserSFTP" == "YES" ]; then
	addgroup $UserToCreate sshdusers &> /dev/null
fi
StatusLSB

#### custumize profile
if [ ! -f $NewUserHomedir/.profile ]; then
	log_daemon_msg "Customize profile for $UserToCreate"
	cp /etc/skel/.bashrc $NewUserHomedir
	cp /etc/skel/.bash_logout $NewUserHomedir
	cp /etc/skel/.profile $NewUserHomedir
	chown $UserToCreate:$UserToCreate $NewUserHomedir/.bashrc
	chown $UserToCreate:$UserToCreate $NewUserHomedir/.bash_logout
	chown $UserToCreate:$UserToCreate $NewUserHomedir/.profile
	perl -pi -e "s/#force_color_prompt=yes/force_color_prompt=yes/g" $NewUserHomedir/.bashrc
	StatusLSB
fi

#### rTorrent (.rtorrent.rc)
log_daemon_msg "Create the rTorrent configuration file for $UserToCreate"
cp /etc/MySB/templates/rtorrent.rc.template $NewUserHomedir/.rtorrent.rc
perl -pi -e "s/<server_ip>/$SrvIpAddress/g" $NewUserHomedir/.rtorrent.rc
perl -pi -e "s/<username>/$UserToCreate/g" $NewUserHomedir/.rtorrent.rc
perl -pi -e "s/<homedir>/$HOMEDIR_ESCAPED/g" $NewUserHomedir/.rtorrent.rc
perl -pi -e "s/<scgi_port>/$SCGIPORT/g" $NewUserHomedir/.rtorrent.rc
perl -pi -e "s/<port_range>/$NETWORKPORT-$NETWORKPORT/g" $NewUserHomedir/.rtorrent.rc
if [ "$MySB_PeerBlock" == "rTorrent" ]; then
	perl -pi -e "s/#{1}ipv4_filter.load/ipv4_filter.load/g" $NewUserHomedir/.rtorrent.rc
	perl -pi -e "s/#{1}print/print/g" $NewUserHomedir/.rtorrent.rc
	perl -pi -e "s/#{1}schedule=load_filter/schedule=load_filter/g" $NewUserHomedir/.rtorrent.rc
fi

case "$FILESYSTEMTYPE" in
	"ext4"|"xfs"|"btrfs")
		perl -pi -e "s/system.file_allocate.set = no/system.file_allocate.set = yes/g" $NewUserHomedir/.rtorrent.rc
	;;	
	*)
		perl -pi -e "s/^system.file_allocate.set = yes/system.file_allocate.set = no/g" $NewUserHomedir/.rtorrent.rc
	;;			
esac
StatusLSB

#### NginX
log_daemon_msg "Creating RPC file for $UserToCreate"
(
cat <<'EOF'
location /<USERNAME> {
	include scgi_params;
	scgi_pass 127.0.0.1:5995;
	auth_basic "MySB";
	auth_basic_user_file "/etc/nginx/passwd/MySB_<username>";
}

EOF
) > /etc/nginx/rpc/$UserToCreate.conf
perl -pi -e "s/5995/$SCGIPORT/g" /etc/nginx/rpc/$UserToCreate.conf
perl -pi -e "s/<username>/$UserToCreate/g" /etc/nginx/rpc/$UserToCreate.conf
perl -pi -e "s/<USERNAME>/$UPPERNEWUSER/g" /etc/nginx/rpc/$UserToCreate.conf
StatusLSB

#### CakeBox
if [ "$IsInstalled_Cakebox" == "YES" ]; then
	log_daemon_msg "Create Cakebox configuration for $UserToCreate"

	(
	cat <<'EOF'
location /<username>/ {
		alias /home/<username>/;
		add_header Content-Disposition "attachment";
		satisfy any;
		allow all;
}

EOF
	) > /etc/nginx/rpc/$UserToCreate.cakebox
	perl -pi -e "s/<username>/$UserToCreate/g" /etc/nginx/rpc/$UserToCreate.cakebox
	
	StatusLSB
fi

#### NFS
if [ -f /etc/exports ]; then
	log_daemon_msg "Create NFS share for $NewUser"
	sed -i '/'$NewUser'/d' /etc/exports
	uid=`grep $NewUser /etc/passwd | awk -F: '{ print $3 }'`
	guid=`grep MySB_users /etc/group | awk -F: '{ print $3 }'`
	echo "/home/$NewUser/rtorrent 10.0.0.0/255.255.255.0(ro,anonuid=$uid,async,anongid=$guid,insecure,no_subtree_check,fsid=0,crossmnt) 10.0.1.0/255.255.255.0(ro,anonuid=$uid,async,anongid=$guid,insecure,no_subtree_check,nohide,fsid=0,crossmnt)" >> /etc/exports
	StatusLSB
fi

#### OpenVPN
if [ "$IsInstalled_OpenVPN" == "YES" ]; then
	log_daemon_msg "Create OpenVPN account for user $UserToCreate"
	screen -dmS OpenVPN_Client /bin/bash /etc/MySB/install/OpenVPN client "$UserToCreate";
	WaitingSTD OpenVPN_Client	
	StatusLSB
fi

#### script init
log_daemon_msg "Create rTorrent init script for $UserToCreate"
cp /etc/MySB/templates/etc.init.rtorrent.template /etc/init.d/rtorrent-$UserToCreate
perl -pi -e "s/<username>/$UserToCreate/g" /etc/init.d/rtorrent-$UserToCreate
chmod +x /etc/init.d/rtorrent-$UserToCreate
update-rc.d rtorrent-$UserToCreate defaults 99 &> /dev/null
StatusLSB

#### cron
log_daemon_msg "Add init script to cron for $UserToCreate"
crontab -l > /tmp/crontab.tmp
sed -i '/'$UserToCreate'/d' /tmp/crontab.tmp
echo "5 * * * * if ! ( /bin/ps U $UserToCreate | grep rtorrent &> /dev/null ); then /etc/init.d/rtorrent-$UserToCreate restart &> /dev/null; fi" >> /tmp/crontab.tmp
echo "0 12 1 * * /bin/bash /etc/MySB/scripts/PaymentReminder.bsh $UserToCreate CRON &> /dev/null" >> /tmp/crontab.tmp
crontab /tmp/crontab.tmp
rm -f /tmp/crontab.tmp
StatusLSB

#### rtorrent max memory & rTorrent Blocklist
for seedUser in $UsersList; do
	log_daemon_msg "Change parameter 'pieces.memory.max.set' for $seedUser"
	LIGN=$(sed -n '/pieces.memory.max.set/=' /home/$seedUser/.rtorrent.rc)
	sed -i ''$LIGN'd' /home/$seedUser/.rtorrent.rc
	sed -i ''$LIGN'i\pieces.memory.max.set = '$(((($MEMORY/$TotalUsers)*1024)*1024))'\n' /home/$seedUser/.rtorrent.rc
	StatusLSB

	if [ -f /etc/MySB/files/blocklists/blocklist_rtorrent.txt ]; then
		log_daemon_msg "Copy the blocklist file for $seedUser"
		cp /etc/MySB/files/blocklists/* $NewUserHomedir/blocklist/
		StatusLSB
	else
		log_daemon_msg "Creating a new blocklist file for $seedUser"
		ScriptInvoke 'screen' '/etc/MySB/scripts/BlocklistsRTorrent.bsh'
		StatusLSB	
	fi

	service rtorrent-$seedUser status &> /dev/null
	if [ $? -gt 0 ]; then
		service rtorrent-$seedUser restart
	else
		service rtorrent-$seedUser reload
	fi
done

#### Assign password
ScriptInvoke "source" "/etc/MySB/bin/MySB_ChangeUserPassword" "$UserToCreate" "$NewUserPassword" "INSTALL"

#### renting
MonthlyPayment "$UserToCreate"

#### START services
ManageServices start "vsftpd nginx nfs-kernel-server cron"
if [ "$TYPE" == "INSTALL" ]; then
	#### START services
	ManageServices start "stunnel4 postfix"
fi

# -----------------------------------------
source /etc/MySB/inc/includes_after
# -----------------------------------------
##################### LAST LINE ######################################